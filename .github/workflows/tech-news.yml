name: Daily Tech News Email

on:
  schedule:
    # Multiple schedules to ensure it runs
    - cron: '30 5 * * *'   # 05:30 UTC = 11:00 AM IST
    - cron: '0 6 * * *'    # 06:00 UTC = 11:30 AM IST (backup)
  
  # Allows manual trigger from GitHub UI
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Run in test mode'
        required: false
        default: 'false'

  # Run on push to main for testing
  push:
    branches: [ main ]

jobs:
  send-daily-tech-news:
    runs-on: ubuntu-latest
    name: Send Daily Tech News Email
    
    steps:
    # Step 1: Checkout code
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    # Step 2: Set up Python
    - name: ðŸ Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    # Step 3: Install dependencies
    - name: ðŸ“¦ Install Python packages
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install feedparser requests beautifulsoup4 python-dotenv
    
    # Step 4: Create environment file
    - name: ðŸ” Set up environment variables
      env:
        SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
        SENDER_PASSWORD: ${{ secrets.SENDER_PASSWORD }}
        RECEIVER_EMAIL: ${{ secrets.RECEIVER_EMAIL }}
      run: |
        echo "Creating .env file..."
        echo "SENDER_EMAIL=$SENDER_EMAIL" > .env
        echo "SENDER_PASSWORD=$SENDER_PASSWORD" >> .env
        echo "RECEIVER_EMAIL=$RECEIVER_EMAIL" >> .env
        echo "GITHUB_ACTIONS=true" >> .env
        echo "Environment file created successfully"
    
    # Step 5: Run the news automation
    - name: ðŸ“¨ Run Tech News Automation
      run: |
        echo "Starting tech news collection at $(date)"
        echo "UTC Time: $(date -u)"
        echo "IST Time: $(TZ='Asia/Kolkata' date)"
        python tech_news_automation.py
    
    # Step 6: Save HTML file as artifact
    - name: ðŸ’¾ Save HTML as artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: tech-news-html-${{ github.run_id }}
        path: |
          Tech_News_Digest_*.html
        retention-days: 7
    
    # Step 7: Send success notification
    - name: âœ… Success Notification
      if: success()
      run: |
        echo "ðŸŽ‰ Tech news email sent successfully!"
        echo "ðŸ“… UTC Time: $(date -u)"
        echo "ðŸ“… IST Time: $(TZ='Asia/Kolkata' date)"
        echo "ðŸ“§ Check your inbox for the daily digest"
